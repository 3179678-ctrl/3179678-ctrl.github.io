<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>摇杆控制器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* 消除触摸高亮 */
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 420px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            font-size: 22px;
            margin-bottom: 20px;
        }
        /* 蓝牙连接 */
        .connection {
            margin-bottom: 20px;
        }
        #connectBtn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #4CAF50;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        #connectBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        /* 速度调节 */
        .speed-control {
            margin-bottom: 20px;
        }
        .speed-control label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 15px;
        }
        #speedSlider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: #ddd;
            border-radius: 4px;
            outline: none;
        }
        #speedSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #4CAF50;
        }
        #speedInfo {
            text-align: center;
            margin-top: 8px;
            font-size: 16px;
            color: #333;
        }
        /* 核心：带内部文字的摇杆容器 */
        .joystick-container {
            position: relative;
            width: 100%;
            max-width: 320px;
            padding-top: 100%; /* 正方形比例（宽=高） */
            margin: 0 auto 20px;
            border-radius: 50%;
            background: #f5f5f5;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.1);
        }
        /* 方向文字（在圈内，靠近边缘） */
        .dir-text {
            position: absolute;
            color: #666;
            font-size: 18px;
            font-weight: bold;
            transform: translate(-50%, -50%); /* 文字中心点对齐定位点 */
            z-index: 1; /* 文字在底层，确保摇杆能盖住 */
        }
        .dir-front { /* 前：圈内上方，距顶部15% */
            top: 15%;
            left: 50%;
        }
        .dir-back { /* 后：圈内下方，距底部15% */
            bottom: 15%;
            left: 50%;
        }
        .dir-left { /* 左：圈内左方，距左侧15% */
            top: 50%;
            left: 15%;
        }
        .dir-right { /* 右：圈内右方，距右侧15% */
            top: 50%;
            right: 15%;
        }
        /* 中间摇杆（可拖动，覆盖文字时触发） */
        .joystick {
            position: absolute;
            width: 32%; /* 摇杆尺寸：容器的32%，确保能完全盖住文字 */
            height: 32%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background: #2196F3;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            touch-action: none; /* 禁止浏览器默认触摸行为 */
            z-index: 2; /* 摇杆在顶层，用于覆盖文字 */
        }
        /* 功能按钮 */
        .func-btns {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        .func-btn {
            flex: 1;
            padding: 12px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            color: white;
            cursor: pointer;
        }
        #stopBtn {
            background: #f44336;
        }
        #baitBtn {
            background: #ff9800;
        }
        /* 状态显示 */
        #status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: #e3f2fd;
            color: #333;
            font-size: 15px;
            min-height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>控制器</h1>
        
        <!-- 蓝牙连接 -->
        <div class="connection">
            <button id="connectBtn">连接蓝牙设备</button>
        </div>
        
        <!-- 速度调节 -->
        <div class="speed-control">
            <label for="speedSlider">速度调节（1-9级）</label>
            <input type="range" id="speedSlider" min="1" max="9" value="5">
            <div id="speedInfo">当前速度：<span id="speedValue">5</span></div>
        </div>
        
        <!-- 核心：带内部方向文字的摇杆 -->
        <div class="joystick-container" id="joystickContainer">
            <!-- 圈内方向文字（前/后/左/右） -->
            <div class="dir-text dir-front" id="dirFront">前</div>
            <div class="dir-text dir-back" id="dirBack">后</div>
            <div class="dir-text dir-left" id="dirLeft">左</div>
            <div class="dir-text dir-right" id="dirRight">右</div>
            
            <!-- 中间可拖动摇杆 -->
            <div class="joystick" id="joystick"></div>
        </div>
        
        <!-- 功能按钮 -->
        <div class="func-btns">
            <button class="func-btn" id="stopBtn">紧急停止</button>
            <button class="func-btn" id="baitBtn">投放料</button>
        </div>
        
        <!-- 状态显示 -->
        <div id="status">未连接，请点击连接按钮</div>
    </div>

    <script>
        // 蓝牙配置（与ESP32一致，小写UUID）
        const SERVICE_UUID = "0000ffe0-0000-1000-8000-00805f9b34fb";
        const CHARACTERISTIC_UUID = "0000ffe1-0000-1000-8000-00805f9b34fb";
        
        // 全局变量
        let device;
        let characteristic;
        let currentSpeed = 5;
        let isJoystickActive = false;
        let lastCmd = "S"; // 上一次指令（默认停止）
        
        // DOM元素
        const connectBtn = document.getElementById('connectBtn');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const status = document.getElementById('status');
        const joystickContainer = document.getElementById('joystickContainer');
        const joystick = document.getElementById('joystick');
        // 方向文字元素（用于判断覆盖）
        const dirFront = document.getElementById('dirFront');
        const dirBack = document.getElementById('dirBack');
        const dirLeft = document.getElementById('dirLeft');
        const dirRight = document.getElementById('dirRight');
        const stopBtn = document.getElementById('stopBtn');
        const baitBtn = document.getElementById('baitBtn');
        
        // 摇杆参数（动态计算，适配屏幕）
        let joystickRect; // 摇杆元素的矩形信息（位置+尺寸）
        let dirRects = {}; // 四个方向文字的矩形信息
        let maxOffset; // 摇杆最大偏移量（确保能覆盖文字，不超出容器）
        
        // 初始化：计算元素位置和尺寸（关键）
        function initPositions() {
            const containerRect = joystickContainer.getBoundingClientRect();
            const containerHalfSize = containerRect.width / 2;
            joystickRect = joystick.getBoundingClientRect();
            const joystickHalfSize = joystickRect.width / 2;
            
            // 计算最大偏移量：容器半径 - 摇杆半径（确保摇杆不超出容器）
            maxOffset = containerHalfSize - joystickHalfSize;
            
            // 存储四个方向文字的矩形信息（用于判断覆盖）
            dirRects = {
                front: dirFront.getBoundingClientRect(),
                back: dirBack.getBoundingClientRect(),
                left: dirLeft.getBoundingClientRect(),
                right: dirRight.getBoundingClientRect()
            };
        }
        
        // 页面加载+窗口 resize 时重新计算位置
        window.addEventListener('load', () => {
            initPositions();
            window.addEventListener('resize', initPositions);
        });
        
        // 速度调节（触摸滑动进度条）
        speedSlider.addEventListener('input', (e) => {
            currentSpeed = parseInt(e.target.value);
            speedValue.textContent = currentSpeed;
        });
        
        // 蓝牙连接逻辑
        connectBtn.addEventListener('click', async () => {
            try {
                status.textContent = "搜索设备中...请选择'BaitBoat'";
                // 请求蓝牙设备（仅移动端触摸交互）
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: "BaitBoat" }],
                    optionalServices: [SERVICE_UUID]
                });
                // 连接GATT服务
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                
                // 更新状态
                connectBtn.disabled = true;
                connectBtn.textContent = "已连接";
                status.textContent = "连接成功，拖动摇杆盖住文字控制方向";
                
                // 监听断开连接
                device.addEventListener('gattserverdisconnected', () => {
                    status.textContent = "设备已断开";
                    connectBtn.disabled = false;
                    connectBtn.textContent = "重新连接";
                    device = null;
                    characteristic = null;
                    stopJoystick(); // 断开时停止摇杆
                });
            } catch (err) {
                status.textContent = err.name === 'NotFoundError' 
                    ? "未找到设备或已取消" 
                    : `连接失败：${err.message}`;
            }
        });
        
        // 发送指令（避免重复发送）
        async function sendCmd(cmd) {
            if (!characteristic) {
                status.textContent = "未连接，无法发送指令";
                return;
            }
            if (cmd === lastCmd) return; // 相同指令不重复发
            
            try {
                await characteristic.writeValue(new TextEncoder().encode(cmd));
                lastCmd = cmd;
                status.textContent = cmd === "S" ? "指令：停止" 
                    : cmd === "D" ? "指令：投放料" 
                    : `指令：${getDirText(cmd[0])}（速度${cmd[1]}）`;
            } catch (err) {
                status.textContent = `发送失败：${err.message}`;
            }
        }
        
        // 辅助：指令方向转文字（如F→前）
        function getDirText(dir) {
            switch(dir) {
                case "F": return "前";
                case "B": return "后";
                case "L": return "左";
                case "R": return "右";
                default: return "";
            }
        }
        
        // 核心逻辑：判断摇杆是否完全盖住文字
        function isJoystickCoverText(joystickCenter, textRect) {
            // 摇杆中心坐标 + 摇杆半径 = 摇杆边缘
            const joystickLeft = joystickCenter.x - joystickRect.width/2;
            const joystickRight = joystickCenter.x + joystickRect.width/2;
            const joystickTop = joystickCenter.y - joystickRect.height/2;
            const joystickBottom = joystickCenter.y + joystickRect.height/2;
            
            // 文字完全在摇杆内部 = 摇杆覆盖文字
            return (
                joystickLeft <= textRect.left && 
                joystickRight >= textRect.right && 
                joystickTop <= textRect.top && 
                joystickBottom >= textRect.bottom
            );
        }
        
        // 摇杆触摸开始
        joystick.addEventListener('touchstart', (e) => {
            e.preventDefault(); // 阻止页面滚动
            isJoystickActive = true;
            // 绑定触摸移动/结束事件
            document.addEventListener('touchmove', moveJoystick);
            document.addEventListener('touchend', stopJoystick);
        });
        
        // 摇杆触摸移动（核心：判断覆盖文字）
        function moveJoystick(e) {
            if (!isJoystickActive) return;
            e.preventDefault();
            
            // 获取触摸点坐标（仅第一个触摸点）
            const touch = e.touches[0];
            const containerRect = joystickContainer.getBoundingClientRect();
            const containerCenter = { // 摇杆容器中心点
                x: containerRect.left + containerRect.width/2,
                y: containerRect.top + containerRect.height/2
            };
            
            // 计算摇杆偏移量（相对于容器中心）
            let offsetX = touch.clientX - containerCenter.x;
            let offsetY = touch.clientY - containerCenter.y;
            
            // 限制偏移量：不超出容器
            const offsetDist = Math.sqrt(offsetX**2 + offsetY**2);
            if (offsetDist > maxOffset) {
                const scale = maxOffset / offsetDist;
                offsetX *= scale;
                offsetY *= scale;
            }
            
            // 更新摇杆位置
            joystick.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;
            
            // 计算当前摇杆中心点坐标（用于判断覆盖）
            const joystickCenter = {
                x: containerCenter.x + offsetX,
                y: containerCenter.y + offsetY
            };
            
            // 判断是否覆盖某个方向文字
            let targetCmd = "S"; // 默认停止
            if (isJoystickCoverText(joystickCenter, dirRects.front)) {
                targetCmd = `F${currentSpeed}`; // 覆盖"前"→前进
            } else if (isJoystickCoverText(joystickCenter, dirRects.back)) {
                targetCmd = `B${currentSpeed}`; // 覆盖"后"→后退
            } else if (isJoystickCoverText(joystickCenter, dirRects.left)) {
                targetCmd = `L${currentSpeed}`; // 覆盖"左"→左转
            } else if (isJoystickCoverText(joystickCenter, dirRects.right)) {
                targetCmd = `R${currentSpeed}`; // 覆盖"右"→右转
            }
            
            // 发送目标指令
            sendCmd(targetCmd);
        }
        
        // 摇杆触摸结束（复位+停止）
        function stopJoystick() {
            if (!isJoystickActive) return;
            isJoystickActive = false;
            // 移除事件监听
            document.removeEventListener('touchmove', moveJoystick);
            document.removeEventListener('touchend', stopJoystick);
            // 摇杆复位
            joystick.style.transform = "translate(-50%, -50%)";
            // 发送停止指令
            sendCmd("S");
        }
        
        // 紧急停止按钮
        stopBtn.addEventListener('click', () => {
            stopJoystick();
            sendCmd("S");
        });
        
        // 投放料按钮
        baitBtn.addEventListener('click', () => {
            sendCmd("D");
        });
    </script>
</body>
</html>
