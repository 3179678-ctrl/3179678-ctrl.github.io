<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID绑定深度</title>
    <!-- 引入Tailwind CSS（样式框架） -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Web3.js（区块链交互，对应原web3.py） -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <style>
        /* 确保中文显示正常（对应原代码SimHei字体） */
        body { font-family: 'Microsoft YaHei', 'Heiti SC', sans-serif; }
        /* 日志区域自动滚动 */
        #logOutput { overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-6">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-5 md:p-7">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 text-center">ID绑定深度</h1>

        <!-- 1. 区块链配置区域 -->
        <div class="mb-8">
            <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">区块链配置</h2>
            
            <!-- RPC URL -->
            <div class="flex flex-col md:flex-row items-start md:items-center mb-4 gap-2">
                <label for="rpcInput" class="w-24 text-gray-600 font-medium">RPC URL:</label>
                <input 
                    type="text" 
                    id="rpcInput" 
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="http://192.168.1.100:8546"
                    value="http://192.168.1.100:8546"
                >
            </div>

            <!-- 合约地址 -->
            <div class="flex flex-col md:flex-row items-start md:items-center mb-4 gap-2">
                <label for="contractInput" class="w-24 text-gray-600 font-medium">合约地址:</label>
                <input 
                    type="text" 
                    id="contractInput" 
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="0x8142FE663fE28E7aEd9B859C0475C8ef7F3C5539"
                    value="0x8142FE663fE28E7aEd9B859C0475C8ef7F3C5539"
                >
            </div>

            <!-- 账户地址 -->
            <div class="flex flex-col md:flex-row items-start md:items-center mb-4 gap-2">
                <label for="accountInput" class="w-24 text-gray-600 font-medium">账户地址:</label>
                <input 
                    type="text" 
                    id="accountInput" 
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="0x..."
                >
            </div>

            <!-- 私钥 + 加载文件按钮 -->
            <div class="flex flex-col md:flex-row items-start md:items-center mb-4 gap-2">
                <label for="privateKeyInput" class="w-24 text-gray-600 font-medium">私钥:</label>
                <input 
                    type="password" 
                    id="privateKeyInput" 
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="64位字符（不含0x或含0x）"
                >
                <label 
                    for="keyFileInput" 
                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md cursor-pointer transition-colors"
                >
                    从文件加载
                </label>
                <input type="file" id="keyFileInput" class="hidden" accept=".txt">
            </div>

            <!-- 保存配置按钮 -->
            <button 
                id="saveConfigBtn" 
                class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors"
            >
                保存配置
            </button>
        </div>

        <!-- 2. 绑定参数区域 -->
        <div class="mb-8">
            <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">绑定参数</h2>
            
            <!-- 根父ID -->
            <div class="flex flex-col md:flex-row items-start md:items-center mb-4 gap-2">
                <label for="rootIdInput" class="w-24 text-gray-600 font-medium">根父ID:</label>
                <input 
                    type="text" 
                    id="rootIdInput" 
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="输入根父ID（如 10000）"
                >
            </div>

            <!-- 绑定深度 -->
            <div class="flex flex-col md:flex-row items-start md:items-center mb-4 gap-2">
                <label for="depthInput" class="w-24 text-gray-600 font-medium">绑定深度:</label>
                <input 
                    type="text" 
                    id="depthInput" 
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="输入深度（1-10，如 3）"
                    value="3"
                >
            </div>
        </div>

        <!-- 3. 进度显示区域 -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
                <label id="progressLabel" class="text-gray-600 font-medium">进度: 0%</label>
            </div>
            <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                <div id="progressBar" class="h-full bg-green-500 w-0 transition-all duration-300"></div>
            </div>
        </div>

        <!-- 4. 控制按钮区域 -->
        <div class="flex gap-4 mb-8">
            <button 
                id="startBtn" 
                class="flex-1 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors"
            >
                开始自动绑定
            </button>
            <button 
                id="stopBtn" 
                class="flex-1 px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors opacity-50 cursor-not-allowed"
                disabled
            >
                停止绑定
            </button>
        </div>

        <!-- 5. 日志区域 -->
        <div>
            <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">操作日志</h2>
            <textarea 
                id="logOutput" 
                class="w-full h-64 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                readonly
                placeholder="操作日志将显示在这里..."></textarea>
        </div>
    </div>

    <!-- Web Worker（修复Web3初始化逻辑：不依赖主线程全局对象，独立初始化） -->
    <script id="bindingWorker" type="javascript/worker">
        let web3 = null;
        let contract = null;
        let isRunning = false;
        let totalSteps = 0;
        let currentStep = 0;

        // 合约ABI（与原代码完全一致）
        const ABI = [
            {
                "inputs": [{"internalType": "uint256","name": "parentRoleID","type": "uint256"}],
                "name": "createRole",
                "outputs": [], "stateMutability": "nonpayable", "type": "function"
            },
            {
                "inputs": [], "name": "totalIds",
                "outputs": [{"internalType": "uint256","name": "","type": "uint256"}],
                "stateMutability": "view", "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256","name": "","type": "uint256"}],
                "name": "parentOf",
                "outputs": [{"internalType": "uint256","name": "","type": "uint256"}],
                "stateMutability": "view", "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256","name": "userId","type": "uint256"}],
                "name": "childrenOf",
                "outputs": [{"internalType": "uint256[]","name": "","type": "uint256[]"}],
                "stateMutability": "view", "type": "function"
            }
        ];

        // 接收主线程消息
        self.onmessage = async (e) => {
            const { type, data } = e.data;

            switch (type) {
                case "START_BINDING":
                    await startBinding(data);
                    break;
                case "STOP_BINDING":
                    stopBinding();
                    break;
                default:
                    sendLog(`未知指令: ${type}`);
            }
        };

        // 开始绑定（核心逻辑，修复Web3初始化）
        async function startBinding(data) {
            const { rpcUrl, contractAddress, accountAddress, privateKey, rootId, depth } = data;
            isRunning = true;
            currentStep = 0;
            totalSteps = calculateTotalSteps(depth);

            try {
                // 修复：Worker内独立初始化Web3（不依赖主线程window.Web3）
                if (typeof Web3 === 'undefined') {
                    // 动态加载Web3.js（防止Worker内未加载）
                    importScripts('https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js');
                }

                // 初始化Web3和合约
                if (!await initWeb3(rpcUrl, contractAddress)) return;
                sendLog(`开始绑定: 根父ID=${rootId}, 深度=${depth}`);

                // 递归绑定角色
                await bindGeneration(rootId, depth, accountAddress, privateKey);
                sendFinished(true, "绑定完成");
            } catch (err) {
                sendLog(`绑定过程出错: ${err.message}`);
                sendFinished(false, `绑定失败: ${err.message}`);
            } finally {
                sendProgress(100); // 最终进度强制100%
            }
        }

        // 停止绑定（对应原BindingThread.stop）
        function stopBinding() {
            isRunning = false;
            sendLog("⏹️ 正在停止绑定过程...");
        }

        // 初始化Web3和合约（修复连接检测方法）
        async function initWeb3(rpcUrl, contractAddress) {
            try {
                // 1. 初始化Web3实例（Worker内独立创建）
                web3 = new Web3(new Web3.providers.HttpProvider(rpcUrl));
                
                // 2. 修复连接检测：用getBlockNumber替代isListening（兼容性更强）
                let isConnected = false;
                try {
                    await web3.eth.getBlockNumber(); // 发送轻量请求检测连接
                    isConnected = true;
                } catch (err) {
                    isConnected = false;
                }
                if (!isConnected) throw new Error("无法连接区块链节点，请检查RPC URL或节点状态");
                sendLog("✅ 已连接区块链节点");

                // 3. 初始化合约
                if (!web3.utils.isAddress(contractAddress)) throw new Error("合约地址格式错误");
                const checksumAddr = web3.utils.toChecksumAddress(contractAddress);
                contract = new web3.eth.Contract(ABI, checksumAddr);
                sendLog(`✅ 合约初始化成功: ${contractAddress}`);
                return true;
            } catch (err) {
                sendLog(`❌ Web3初始化失败: ${err.message}`);
                return false;
            }
        }

        // 递归绑定角色（逻辑不变）
        async function bindGeneration(parentId, generationsLeft, accountAddress, privateKey) {
            if (!isRunning || generationsLeft <= 0) return;

            try {
                // 1. 获取父节点现有子节点
                const existingChildren = await contract.methods.childrenOf(parentId).call();
                sendLog(`父ID ${parentId} 已有子节点: ${existingChildren.join(', ') || '无'}`);

                // 2. 获取下一个可用ID
                const total = await contract.methods.totalIds().call();
                const nextId = Number(total) + 1;
                sendLog(`当前总ID数: ${total}, 下一个可用ID: ${nextId}`);

                // 3. 若下一个ID不在子节点中，创建新角色
                if (!existingChildren.includes(nextId.toString())) {
                    sendLog(`准备生成新角色: ID=${nextId}, parent=${parentId}`);
                    const [success, txHash] = await sendCreateRole(parentId, accountAddress, privateKey);
                    if (!success) {
                        sendLog(`创建角色 ${nextId} 失败，停止绑定过程`);
                        throw new Error(`角色创建失败: ID=${nextId}`);
                    }
                    // 等待交易确认
                    await waitForTransactionConfirmation(txHash);
                }

                // 4. 更新进度
                updateProgress();

                // 5. 递归处理下一代
                const updatedChildren = await contract.methods.childrenOf(parentId).call();
                for (const childId of updatedChildren) {
                    if (!isRunning) break;
                    await bindGeneration(Number(childId), generationsLeft - 1, accountAddress, privateKey);
                }
            } catch (err) {
                sendLog(`处理父ID ${parentId} 时出错: ${err.message}`);
                throw err;
            }
        }

        // 发送创建角色交易（逻辑不变）
        async function sendCreateRole(parentId, accountAddress, privateKey) {
            try {
                // 1. 获取Nonce（账户交易次数）
                const nonce = await web3.eth.getTransactionCount(accountAddress);
                sendLog(`使用Nonce: ${nonce}`);

                // 2. 估算Gas（带20%缓冲）
                let gas;
                try {
                    const gasEstimate = await contract.methods.createRole(parentId).estimateGas({ from: accountAddress });
                    gas = Math.floor(gasEstimate * 1.2); // 增加20%缓冲
                    sendLog(`估算Gas: ${gasEstimate}, 使用Gas: ${gas}`);
                } catch (err) {
                    gas = 200000; // 默认Gas值
                    sendLog(`估算Gas失败: ${err.message}, 使用默认值: ${gas}`);
                }

                // 3. 构建交易对象
                const txObject = {
                    from: accountAddress,
                    to: contract.options.address,
                    nonce: web3.utils.toHex(nonce),
                    gas: web3.utils.toHex(gas),
                    gasPrice: await web3.eth.getGasPrice(), // 获取当前Gas Price
                    data: contract.methods.createRole(parentId).encodeABI() // 编码合约调用
                };

                // 4. 签名交易（私钥签名）
                const signedTx = await web3.eth.accounts.signTransaction(txObject, privateKey);
                if (!signedTx.rawTransaction) throw new Error("交易签名失败");

                // 5. 发送交易
                const txHash = await web3.eth.sendSignedTransaction(signedTx.rawTransaction);
                sendLog(`📤 提交交易成功: ${txHash.transactionHash}`);
                return [true, txHash.transactionHash];
            } catch (err) {
                sendLog(`Web3交易错误: ${err.message}`);
                return [false, null];
            }
        }

        // 等待交易确认（逻辑不变）
        async function waitForTransactionConfirmation(txHash, timeout = 300) {
            sendLog(`等待交易确认: ${txHash}`);
            const startTime = Date.now();

            return new Promise((resolve) => {
                const checkInterval = setInterval(async () => {
                    // 超时或停止绑定，终止等待
                    if (!isRunning || (Date.now() - startTime) > timeout * 1000) {
                        clearInterval(checkInterval);
                        if (!isRunning) sendLog("绑定已停止，终止交易确认等待");
                        else sendLog(`⌛ 交易确认超时 (${timeout}秒)`);
                        resolve(false);
                        return;
                    }

                    // 检查交易收据
                    try {
                        const receipt = await web3.eth.getTransactionReceipt(txHash);
                        if (receipt) {
                            clearInterval(checkInterval);
                            if (receipt.status) {
                                sendLog(`✅ 交易已确认，区块号: ${receipt.blockNumber}`);
                                resolve(true);
                            } else {
                                sendLog(`❌ 交易失败，状态码: ${receipt.status}`);
                                resolve(false);
                            }
                        }
                    } catch (err) {
                        sendLog(`检查交易收据出错: ${err.message}`);
                    }
                }, 2000); // 每2秒检查一次
            });
        }

        // 计算总步骤（二叉树总节点数）
        function calculateTotalSteps(depth) {
            return (2 ** (depth + 1)) - 1;
        }

        // 更新进度
        function updateProgress() {
            currentStep += 1;
            const progress = Math.min(Math.floor((currentStep / totalSteps) * 100), 100);
            sendProgress(progress);
        }

        // 发送日志到主线程
        function sendLog(msg) {
            const timestamp = new Date().toTimeString().slice(0, 8); // 格式: HH:MM:SS
            self.postMessage({ type: "LOG", data: `[${timestamp}] ${msg}` });
        }

        // 发送进度到主线程
        function sendProgress(value) {
            self.postMessage({ type: "PROGRESS", data: value });
        }

        // 发送完成状态到主线程
        function sendFinished(success, message) {
            self.postMessage({ type: "FINISHED", data: { success, message } });
        }
    </script>

    <!-- 主线程JS（逻辑不变，仅优化默认值） -->
    <script>
        // DOM元素获取
        const rpcInput = document.getElementById('rpcInput');
        const contractInput = document.getElementById('contractInput');
        const accountInput = document.getElementById('accountInput');
        const privateKeyInput = document.getElementById('privateKeyInput');
        const keyFileInput = document.getElementById('keyFileInput');
        const saveConfigBtn = document.getElementById('saveConfigBtn');
        const rootIdInput = document.getElementById('rootIdInput');
        const depthInput = document.getElementById('depthInput');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const progressLabel = document.getElementById('progressLabel');
        const progressBar = document.getElementById('progressBar');
        const logOutput = document.getElementById('logOutput');

        // 默认配置（与原代码一致）
        const DEFAULT_CONFIG = {
            contract_address: "0x8142FE663fE28E7aEd9B859C0475C8ef7F3C5539",
            rpc_url: "http://192.168.1.100:8546",
            account_address: "",
            private_key: ""
        };

        // Web Worker初始化（从script标签创建Worker）
        const workerScript = document.getElementById('bindingWorker').textContent;
        const blob = new Blob([workerScript], { type: 'application/javascript' });
        const bindingWorker = new Worker(URL.createObjectURL(blob));

        // 页面加载时加载配置
        window.onload = loadConfig;

        // 1. 配置管理：加载配置（LocalStorage替代config.json）
        function loadConfig() {
            try {
                const savedConfig = JSON.parse(localStorage.getItem('familyBinderConfig')) || {};
                const config = { ...DEFAULT_CONFIG, ...savedConfig };
                
                // 填充到输入框
                rpcInput.value = config.rpc_url;
                contractInput.value = config.contract_address;
                accountInput.value = config.account_address;
                privateKeyInput.value = config.private_key;
                
                log(`🔎 配置加载完成`);
                // 检测Web3版本（主线程）
                if (window.Web3) log(`🔎 检测到 web3.js 版本: ${Web3.version}`);
                else log("⚠️ 主线程未检测到 web3.js 库，请刷新页面");
            } catch (err) {
                log(`⚠️ 加载配置失败: ${err.message}`);
                // 加载默认配置
                rpcInput.value = DEFAULT_CONFIG.rpc_url;
                contractInput.value = DEFAULT_CONFIG.contract_address;
            }
        }

        // 2. 配置管理：保存配置
        saveConfigBtn.addEventListener('click', async () => {
            try {
                // 验证地址格式
                const contractAddr = contractInput.value.trim();
                const accountAddr = accountInput.value.trim();
                
                if (contractAddr && !Web3.utils.isAddress(contractAddr)) {
                    throw new Error("合约地址格式错误");
                }
                if (accountAddr && !Web3.utils.isAddress(accountAddr)) {
                    throw new Error("账户地址格式错误");
                }

                // 构建配置对象
                const config = {
                    rpc_url: rpcInput.value.trim(),
                    contract_address: contractAddr,
                    account_address: accountAddr,
                    private_key: privateKeyInput.value.trim()
                };

                // 保存到LocalStorage
                localStorage.setItem('familyBinderConfig', JSON.stringify(config));
                log("✅ 配置已保存");
                alert("配置已保存");
            } catch (err) {
                log(`❌ 保存配置失败: ${err.message}`);
                alert(`保存配置失败: ${err.message}`);
            }
        });

        // 3. 加载私钥文件
        keyFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    let privateKey = event.target.result.trim();
                    // 处理0x前缀
                    if (privateKey.startsWith('0x')) privateKey = privateKey.slice(2);
                    // 验证私钥长度（64位16进制字符）
                    if (!/^[0-9a-fA-F]{64}$/.test(privateKey)) {
                        throw new Error("私钥格式不正确，应为64个字符的16进制字符串");
                    }
                    privateKeyInput.value = privateKey;
                    log(`✅ 已从文件加载私钥: ${file.name}`);
                } catch (err) {
                    log(`❌ 加载私钥文件失败: ${err.message}`);
                    alert(`加载私钥文件失败: ${err.message}`);
                }
            };
            reader.readAsText(file);
        });

        // 4. 开始绑定
        startBtn.addEventListener('click', async () => {
            try {
                // 验证输入参数
                const rootId = parseInt(rootIdInput.value.trim());
                const depth = parseInt(depthInput.value.trim());
                const rpcUrl = rpcInput.value.trim();
                const contractAddr = contractInput.value.trim();
                const accountAddr = accountInput.value.trim();
                const privateKey = privateKeyInput.value.trim();

                // 基础验证
                if (!rpcUrl) throw new Error("请输入RPC URL");
                if (!contractAddr) throw new Error("请输入合约地址");
                if (!accountAddr) throw new Error("请输入账户地址");
                if (!privateKey) throw new Error("请输入私钥");
                if (isNaN(rootId) || rootId <= 0) throw new Error("根父ID必须为正整数");
                if (isNaN(depth) || depth < 1 || depth > 1000) throw new Error("深度必须为1-10之间的整数");

                // 验证地址格式
                if (!Web3.utils.isAddress(contractAddr)) throw new Error("合约地址格式错误");
                if (!Web3.utils.isAddress(accountAddr)) throw new Error("账户地址格式错误");
                // 验证私钥格式
                const key = privateKey.startsWith('0x') ? privateKey.slice(2) : privateKey;
                if (!/^[0-9a-fA-F]{64}$/.test(key)) throw new Error("私钥格式不正确");

                // 切换按钮状态
                startBtn.disabled = true;
                stopBtn.disabled = false;
                saveConfigBtn.disabled = true;
                startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                // 重置进度
                progressBar.style.width = '0%';
                progressLabel.textContent = '进度: 0%';

                // 发送指令给Worker（携带完整参数）
                bindingWorker.postMessage({
                    type: "START_BINDING",
                    data: {
                        rpcUrl,
                        contractAddress: Web3.utils.toChecksumAddress(contractAddr),
                        accountAddress: Web3.utils.toChecksumAddress(accountAddr),
                        privateKey: privateKey.startsWith('0x') ? privateKey : `0x${privateKey}`,
                        rootId,
                        depth
                    }
                });
            } catch (err) {
                log(`⚠️ 输入错误: ${err.message}`);
                alert(`输入错误: ${err.message}`);
            }
        });

        // 5. 停止绑定
        stopBtn.addEventListener('click', () => {
            bindingWorker.postMessage({ type: "STOP_BINDING" });
            stopBtn.disabled = true;
            stopBtn.classList.add('opacity-50', 'cursor-not-allowed');
        });

        // 6. 接收Worker消息（更新UI）
        bindingWorker.onmessage = (e) => {
            const { type, data } = e.data;

            switch (type) {
                case "LOG":
                    log(data);
                    break;
                case "PROGRESS":
                    progressBar.style.width = `${data}%`;
                    progressLabel.textContent = `进度: ${data}%`;
                    break;
                case "FINISHED":
                    const { success, message } = data;
                    log(message);
                    // 恢复按钮状态
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    saveConfigBtn.disabled = false;
                    startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    stopBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    // 提示结果
                    alert(message);
                    break;
            }
        };

        // 7. 日志工具
        function log(msg) {
            logOutput.value += `${msg}\n`;
            // 自动滚动到底部
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // 8. 页面关闭时终止Worker
        window.onbeforeunload = () => {
            bindingWorker.terminate();
        };
    </script>
</body>
</html>