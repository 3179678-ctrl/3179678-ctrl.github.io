<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDç»‘å®šæ·±åº¦</title>
    <!-- å¼•å…¥Tailwind CSSï¼ˆæ ·å¼æ¡†æ¶ï¼‰ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥Web3.jsï¼ˆåŒºå—é“¾äº¤äº’ï¼Œå¯¹åº”åŸweb3.pyï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <style>
        /* ç¡®ä¿ä¸­æ–‡æ˜¾ç¤ºæ­£å¸¸ï¼ˆå¯¹åº”åŸä»£ç SimHeiå­—ä½“ï¼‰ */
        body { font-family: 'Microsoft YaHei', 'Heiti SC', sans-serif; }
        /* æ—¥å¿—åŒºåŸŸè‡ªåŠ¨æ»šåŠ¨ */
        #logOutput { overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-6">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-5 md:p-7">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 text-center">IDç»‘å®šæ·±åº¦</h1>

        <!-- 1. åŒºå—é“¾é…ç½®åŒºåŸŸ -->
        <div class="mb-8">
            <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">åŒºå—é“¾é…ç½®</h2>
            
            <!-- RPC URL -->
            <div class="flex flex-col md:flex-row items-start md:items-center mb-4 gap-2">
                <label for="rpcInput" class="w-24 text-gray-600 font-medium">RPC URL:</label>
                <input 
                    type="text" 
                    id="rpcInput" 
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="http://192.168.1.100:8546"
                    value="http://192.168.1.100:8546"
                >
            </div>

            <!-- åˆçº¦åœ°å€ -->
            <div class="flex flex-col md:flex-row items-start md:items-center mb-4 gap-2">
                <label for="contractInput" class="w-24 text-gray-600 font-medium">åˆçº¦åœ°å€:</label>
                <input 
                    type="text" 
                    id="contractInput" 
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="0x8142FE663fE28E7aEd9B859C0475C8ef7F3C5539"
                    value="0x8142FE663fE28E7aEd9B859C0475C8ef7F3C5539"
                >
            </div>

            <!-- è´¦æˆ·åœ°å€ -->
            <div class="flex flex-col md:flex-row items-start md:items-center mb-4 gap-2">
                <label for="accountInput" class="w-24 text-gray-600 font-medium">è´¦æˆ·åœ°å€:</label>
                <input 
                    type="text" 
                    id="accountInput" 
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="0x..."
                >
            </div>

            <!-- ç§é’¥ + åŠ è½½æ–‡ä»¶æŒ‰é’® -->
            <div class="flex flex-col md:flex-row items-start md:items-center mb-4 gap-2">
                <label for="privateKeyInput" class="w-24 text-gray-600 font-medium">ç§é’¥:</label>
                <input 
                    type="password" 
                    id="privateKeyInput" 
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="64ä½å­—ç¬¦ï¼ˆä¸å«0xæˆ–å«0xï¼‰"
                >
                <label 
                    for="keyFileInput" 
                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md cursor-pointer transition-colors"
                >
                    ä»æ–‡ä»¶åŠ è½½
                </label>
                <input type="file" id="keyFileInput" class="hidden" accept=".txt">
            </div>

            <!-- ä¿å­˜é…ç½®æŒ‰é’® -->
            <button 
                id="saveConfigBtn" 
                class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors"
            >
                ä¿å­˜é…ç½®
            </button>
        </div>

        <!-- 2. ç»‘å®šå‚æ•°åŒºåŸŸ -->
        <div class="mb-8">
            <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">ç»‘å®šå‚æ•°</h2>
            
            <!-- æ ¹çˆ¶ID -->
            <div class="flex flex-col md:flex-row items-start md:items-center mb-4 gap-2">
                <label for="rootIdInput" class="w-24 text-gray-600 font-medium">æ ¹çˆ¶ID:</label>
                <input 
                    type="text" 
                    id="rootIdInput" 
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="è¾“å…¥æ ¹çˆ¶IDï¼ˆå¦‚ 10000ï¼‰"
                >
            </div>

            <!-- ç»‘å®šæ·±åº¦ -->
            <div class="flex flex-col md:flex-row items-start md:items-center mb-4 gap-2">
                <label for="depthInput" class="w-24 text-gray-600 font-medium">ç»‘å®šæ·±åº¦:</label>
                <input 
                    type="text" 
                    id="depthInput" 
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="è¾“å…¥æ·±åº¦ï¼ˆ1-10ï¼Œå¦‚ 3ï¼‰"
                    value="3"
                >
            </div>
        </div>

        <!-- 3. è¿›åº¦æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
                <label id="progressLabel" class="text-gray-600 font-medium">è¿›åº¦: 0%</label>
            </div>
            <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                <div id="progressBar" class="h-full bg-green-500 w-0 transition-all duration-300"></div>
            </div>
        </div>

        <!-- 4. æ§åˆ¶æŒ‰é’®åŒºåŸŸ -->
        <div class="flex gap-4 mb-8">
            <button 
                id="startBtn" 
                class="flex-1 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors"
            >
                å¼€å§‹è‡ªåŠ¨ç»‘å®š
            </button>
            <button 
                id="stopBtn" 
                class="flex-1 px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors opacity-50 cursor-not-allowed"
                disabled
            >
                åœæ­¢ç»‘å®š
            </button>
        </div>

        <!-- 5. æ—¥å¿—åŒºåŸŸ -->
        <div>
            <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">æ“ä½œæ—¥å¿—</h2>
            <textarea 
                id="logOutput" 
                class="w-full h-64 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                readonly
                placeholder="æ“ä½œæ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
        </div>
    </div>

    <!-- Web Workerï¼ˆä¿®å¤Web3åˆå§‹åŒ–é€»è¾‘ï¼šä¸ä¾èµ–ä¸»çº¿ç¨‹å…¨å±€å¯¹è±¡ï¼Œç‹¬ç«‹åˆå§‹åŒ–ï¼‰ -->
    <script id="bindingWorker" type="javascript/worker">
        let web3 = null;
        let contract = null;
        let isRunning = false;
        let totalSteps = 0;
        let currentStep = 0;

        // åˆçº¦ABIï¼ˆä¸åŸä»£ç å®Œå…¨ä¸€è‡´ï¼‰
        const ABI = [
            {
                "inputs": [{"internalType": "uint256","name": "parentRoleID","type": "uint256"}],
                "name": "createRole",
                "outputs": [], "stateMutability": "nonpayable", "type": "function"
            },
            {
                "inputs": [], "name": "totalIds",
                "outputs": [{"internalType": "uint256","name": "","type": "uint256"}],
                "stateMutability": "view", "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256","name": "","type": "uint256"}],
                "name": "parentOf",
                "outputs": [{"internalType": "uint256","name": "","type": "uint256"}],
                "stateMutability": "view", "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256","name": "userId","type": "uint256"}],
                "name": "childrenOf",
                "outputs": [{"internalType": "uint256[]","name": "","type": "uint256[]"}],
                "stateMutability": "view", "type": "function"
            }
        ];

        // æ¥æ”¶ä¸»çº¿ç¨‹æ¶ˆæ¯
        self.onmessage = async (e) => {
            const { type, data } = e.data;

            switch (type) {
                case "START_BINDING":
                    await startBinding(data);
                    break;
                case "STOP_BINDING":
                    stopBinding();
                    break;
                default:
                    sendLog(`æœªçŸ¥æŒ‡ä»¤: ${type}`);
            }
        };

        // å¼€å§‹ç»‘å®šï¼ˆæ ¸å¿ƒé€»è¾‘ï¼Œä¿®å¤Web3åˆå§‹åŒ–ï¼‰
        async function startBinding(data) {
            const { rpcUrl, contractAddress, accountAddress, privateKey, rootId, depth } = data;
            isRunning = true;
            currentStep = 0;
            totalSteps = calculateTotalSteps(depth);

            try {
                // ä¿®å¤ï¼šWorkerå†…ç‹¬ç«‹åˆå§‹åŒ–Web3ï¼ˆä¸ä¾èµ–ä¸»çº¿ç¨‹window.Web3ï¼‰
                if (typeof Web3 === 'undefined') {
                    // åŠ¨æ€åŠ è½½Web3.jsï¼ˆé˜²æ­¢Workerå†…æœªåŠ è½½ï¼‰
                    importScripts('https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js');
                }

                // åˆå§‹åŒ–Web3å’Œåˆçº¦
                if (!await initWeb3(rpcUrl, contractAddress)) return;
                sendLog(`å¼€å§‹ç»‘å®š: æ ¹çˆ¶ID=${rootId}, æ·±åº¦=${depth}`);

                // é€’å½’ç»‘å®šè§’è‰²
                await bindGeneration(rootId, depth, accountAddress, privateKey);
                sendFinished(true, "ç»‘å®šå®Œæˆ");
            } catch (err) {
                sendLog(`ç»‘å®šè¿‡ç¨‹å‡ºé”™: ${err.message}`);
                sendFinished(false, `ç»‘å®šå¤±è´¥: ${err.message}`);
            } finally {
                sendProgress(100); // æœ€ç»ˆè¿›åº¦å¼ºåˆ¶100%
            }
        }

        // åœæ­¢ç»‘å®šï¼ˆå¯¹åº”åŸBindingThread.stopï¼‰
        function stopBinding() {
            isRunning = false;
            sendLog("â¹ï¸ æ­£åœ¨åœæ­¢ç»‘å®šè¿‡ç¨‹...");
        }

        // åˆå§‹åŒ–Web3å’Œåˆçº¦ï¼ˆä¿®å¤è¿æ¥æ£€æµ‹æ–¹æ³•ï¼‰
        async function initWeb3(rpcUrl, contractAddress) {
            try {
                // 1. åˆå§‹åŒ–Web3å®ä¾‹ï¼ˆWorkerå†…ç‹¬ç«‹åˆ›å»ºï¼‰
                web3 = new Web3(new Web3.providers.HttpProvider(rpcUrl));
                
                // 2. ä¿®å¤è¿æ¥æ£€æµ‹ï¼šç”¨getBlockNumberæ›¿ä»£isListeningï¼ˆå…¼å®¹æ€§æ›´å¼ºï¼‰
                let isConnected = false;
                try {
                    await web3.eth.getBlockNumber(); // å‘é€è½»é‡è¯·æ±‚æ£€æµ‹è¿æ¥
                    isConnected = true;
                } catch (err) {
                    isConnected = false;
                }
                if (!isConnected) throw new Error("æ— æ³•è¿æ¥åŒºå—é“¾èŠ‚ç‚¹ï¼Œè¯·æ£€æŸ¥RPC URLæˆ–èŠ‚ç‚¹çŠ¶æ€");
                sendLog("âœ… å·²è¿æ¥åŒºå—é“¾èŠ‚ç‚¹");

                // 3. åˆå§‹åŒ–åˆçº¦
                if (!web3.utils.isAddress(contractAddress)) throw new Error("åˆçº¦åœ°å€æ ¼å¼é”™è¯¯");
                const checksumAddr = web3.utils.toChecksumAddress(contractAddress);
                contract = new web3.eth.Contract(ABI, checksumAddr);
                sendLog(`âœ… åˆçº¦åˆå§‹åŒ–æˆåŠŸ: ${contractAddress}`);
                return true;
            } catch (err) {
                sendLog(`âŒ Web3åˆå§‹åŒ–å¤±è´¥: ${err.message}`);
                return false;
            }
        }

        // é€’å½’ç»‘å®šè§’è‰²ï¼ˆé€»è¾‘ä¸å˜ï¼‰
        async function bindGeneration(parentId, generationsLeft, accountAddress, privateKey) {
            if (!isRunning || generationsLeft <= 0) return;

            try {
                // 1. è·å–çˆ¶èŠ‚ç‚¹ç°æœ‰å­èŠ‚ç‚¹
                const existingChildren = await contract.methods.childrenOf(parentId).call();
                sendLog(`çˆ¶ID ${parentId} å·²æœ‰å­èŠ‚ç‚¹: ${existingChildren.join(', ') || 'æ— '}`);

                // 2. è·å–ä¸‹ä¸€ä¸ªå¯ç”¨ID
                const total = await contract.methods.totalIds().call();
                const nextId = Number(total) + 1;
                sendLog(`å½“å‰æ€»IDæ•°: ${total}, ä¸‹ä¸€ä¸ªå¯ç”¨ID: ${nextId}`);

                // 3. è‹¥ä¸‹ä¸€ä¸ªIDä¸åœ¨å­èŠ‚ç‚¹ä¸­ï¼Œåˆ›å»ºæ–°è§’è‰²
                if (!existingChildren.includes(nextId.toString())) {
                    sendLog(`å‡†å¤‡ç”Ÿæˆæ–°è§’è‰²: ID=${nextId}, parent=${parentId}`);
                    const [success, txHash] = await sendCreateRole(parentId, accountAddress, privateKey);
                    if (!success) {
                        sendLog(`åˆ›å»ºè§’è‰² ${nextId} å¤±è´¥ï¼Œåœæ­¢ç»‘å®šè¿‡ç¨‹`);
                        throw new Error(`è§’è‰²åˆ›å»ºå¤±è´¥: ID=${nextId}`);
                    }
                    // ç­‰å¾…äº¤æ˜“ç¡®è®¤
                    await waitForTransactionConfirmation(txHash);
                }

                // 4. æ›´æ–°è¿›åº¦
                updateProgress();

                // 5. é€’å½’å¤„ç†ä¸‹ä¸€ä»£
                const updatedChildren = await contract.methods.childrenOf(parentId).call();
                for (const childId of updatedChildren) {
                    if (!isRunning) break;
                    await bindGeneration(Number(childId), generationsLeft - 1, accountAddress, privateKey);
                }
            } catch (err) {
                sendLog(`å¤„ç†çˆ¶ID ${parentId} æ—¶å‡ºé”™: ${err.message}`);
                throw err;
            }
        }

        // å‘é€åˆ›å»ºè§’è‰²äº¤æ˜“ï¼ˆé€»è¾‘ä¸å˜ï¼‰
        async function sendCreateRole(parentId, accountAddress, privateKey) {
            try {
                // 1. è·å–Nonceï¼ˆè´¦æˆ·äº¤æ˜“æ¬¡æ•°ï¼‰
                const nonce = await web3.eth.getTransactionCount(accountAddress);
                sendLog(`ä½¿ç”¨Nonce: ${nonce}`);

                // 2. ä¼°ç®—Gasï¼ˆå¸¦20%ç¼“å†²ï¼‰
                let gas;
                try {
                    const gasEstimate = await contract.methods.createRole(parentId).estimateGas({ from: accountAddress });
                    gas = Math.floor(gasEstimate * 1.2); // å¢åŠ 20%ç¼“å†²
                    sendLog(`ä¼°ç®—Gas: ${gasEstimate}, ä½¿ç”¨Gas: ${gas}`);
                } catch (err) {
                    gas = 200000; // é»˜è®¤Gaså€¼
                    sendLog(`ä¼°ç®—Gaså¤±è´¥: ${err.message}, ä½¿ç”¨é»˜è®¤å€¼: ${gas}`);
                }

                // 3. æ„å»ºäº¤æ˜“å¯¹è±¡
                const txObject = {
                    from: accountAddress,
                    to: contract.options.address,
                    nonce: web3.utils.toHex(nonce),
                    gas: web3.utils.toHex(gas),
                    gasPrice: await web3.eth.getGasPrice(), // è·å–å½“å‰Gas Price
                    data: contract.methods.createRole(parentId).encodeABI() // ç¼–ç åˆçº¦è°ƒç”¨
                };

                // 4. ç­¾åäº¤æ˜“ï¼ˆç§é’¥ç­¾åï¼‰
                const signedTx = await web3.eth.accounts.signTransaction(txObject, privateKey);
                if (!signedTx.rawTransaction) throw new Error("äº¤æ˜“ç­¾åå¤±è´¥");

                // 5. å‘é€äº¤æ˜“
                const txHash = await web3.eth.sendSignedTransaction(signedTx.rawTransaction);
                sendLog(`ğŸ“¤ æäº¤äº¤æ˜“æˆåŠŸ: ${txHash.transactionHash}`);
                return [true, txHash.transactionHash];
            } catch (err) {
                sendLog(`Web3äº¤æ˜“é”™è¯¯: ${err.message}`);
                return [false, null];
            }
        }

        // ç­‰å¾…äº¤æ˜“ç¡®è®¤ï¼ˆé€»è¾‘ä¸å˜ï¼‰
        async function waitForTransactionConfirmation(txHash, timeout = 300) {
            sendLog(`ç­‰å¾…äº¤æ˜“ç¡®è®¤: ${txHash}`);
            const startTime = Date.now();

            return new Promise((resolve) => {
                const checkInterval = setInterval(async () => {
                    // è¶…æ—¶æˆ–åœæ­¢ç»‘å®šï¼Œç»ˆæ­¢ç­‰å¾…
                    if (!isRunning || (Date.now() - startTime) > timeout * 1000) {
                        clearInterval(checkInterval);
                        if (!isRunning) sendLog("ç»‘å®šå·²åœæ­¢ï¼Œç»ˆæ­¢äº¤æ˜“ç¡®è®¤ç­‰å¾…");
                        else sendLog(`âŒ› äº¤æ˜“ç¡®è®¤è¶…æ—¶ (${timeout}ç§’)`);
                        resolve(false);
                        return;
                    }

                    // æ£€æŸ¥äº¤æ˜“æ”¶æ®
                    try {
                        const receipt = await web3.eth.getTransactionReceipt(txHash);
                        if (receipt) {
                            clearInterval(checkInterval);
                            if (receipt.status) {
                                sendLog(`âœ… äº¤æ˜“å·²ç¡®è®¤ï¼ŒåŒºå—å·: ${receipt.blockNumber}`);
                                resolve(true);
                            } else {
                                sendLog(`âŒ äº¤æ˜“å¤±è´¥ï¼ŒçŠ¶æ€ç : ${receipt.status}`);
                                resolve(false);
                            }
                        }
                    } catch (err) {
                        sendLog(`æ£€æŸ¥äº¤æ˜“æ”¶æ®å‡ºé”™: ${err.message}`);
                    }
                }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
            });
        }

        // è®¡ç®—æ€»æ­¥éª¤ï¼ˆäºŒå‰æ ‘æ€»èŠ‚ç‚¹æ•°ï¼‰
        function calculateTotalSteps(depth) {
            return (2 ** (depth + 1)) - 1;
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            currentStep += 1;
            const progress = Math.min(Math.floor((currentStep / totalSteps) * 100), 100);
            sendProgress(progress);
        }

        // å‘é€æ—¥å¿—åˆ°ä¸»çº¿ç¨‹
        function sendLog(msg) {
            const timestamp = new Date().toTimeString().slice(0, 8); // æ ¼å¼: HH:MM:SS
            self.postMessage({ type: "LOG", data: `[${timestamp}] ${msg}` });
        }

        // å‘é€è¿›åº¦åˆ°ä¸»çº¿ç¨‹
        function sendProgress(value) {
            self.postMessage({ type: "PROGRESS", data: value });
        }

        // å‘é€å®ŒæˆçŠ¶æ€åˆ°ä¸»çº¿ç¨‹
        function sendFinished(success, message) {
            self.postMessage({ type: "FINISHED", data: { success, message } });
        }
    </script>

    <!-- ä¸»çº¿ç¨‹JSï¼ˆé€»è¾‘ä¸å˜ï¼Œä»…ä¼˜åŒ–é»˜è®¤å€¼ï¼‰ -->
    <script>
        // DOMå…ƒç´ è·å–
        const rpcInput = document.getElementById('rpcInput');
        const contractInput = document.getElementById('contractInput');
        const accountInput = document.getElementById('accountInput');
        const privateKeyInput = document.getElementById('privateKeyInput');
        const keyFileInput = document.getElementById('keyFileInput');
        const saveConfigBtn = document.getElementById('saveConfigBtn');
        const rootIdInput = document.getElementById('rootIdInput');
        const depthInput = document.getElementById('depthInput');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const progressLabel = document.getElementById('progressLabel');
        const progressBar = document.getElementById('progressBar');
        const logOutput = document.getElementById('logOutput');

        // é»˜è®¤é…ç½®ï¼ˆä¸åŸä»£ç ä¸€è‡´ï¼‰
        const DEFAULT_CONFIG = {
            contract_address: "0x8142FE663fE28E7aEd9B859C0475C8ef7F3C5539",
            rpc_url: "http://192.168.1.100:8546",
            account_address: "",
            private_key: ""
        };

        // Web Workeråˆå§‹åŒ–ï¼ˆä»scriptæ ‡ç­¾åˆ›å»ºWorkerï¼‰
        const workerScript = document.getElementById('bindingWorker').textContent;
        const blob = new Blob([workerScript], { type: 'application/javascript' });
        const bindingWorker = new Worker(URL.createObjectURL(blob));

        // é¡µé¢åŠ è½½æ—¶åŠ è½½é…ç½®
        window.onload = loadConfig;

        // 1. é…ç½®ç®¡ç†ï¼šåŠ è½½é…ç½®ï¼ˆLocalStorageæ›¿ä»£config.jsonï¼‰
        function loadConfig() {
            try {
                const savedConfig = JSON.parse(localStorage.getItem('familyBinderConfig')) || {};
                const config = { ...DEFAULT_CONFIG, ...savedConfig };
                
                // å¡«å……åˆ°è¾“å…¥æ¡†
                rpcInput.value = config.rpc_url;
                contractInput.value = config.contract_address;
                accountInput.value = config.account_address;
                privateKeyInput.value = config.private_key;
                
                log(`ğŸ” é…ç½®åŠ è½½å®Œæˆ`);
                // æ£€æµ‹Web3ç‰ˆæœ¬ï¼ˆä¸»çº¿ç¨‹ï¼‰
                if (window.Web3) log(`ğŸ” æ£€æµ‹åˆ° web3.js ç‰ˆæœ¬: ${Web3.version}`);
                else log("âš ï¸ ä¸»çº¿ç¨‹æœªæ£€æµ‹åˆ° web3.js åº“ï¼Œè¯·åˆ·æ–°é¡µé¢");
            } catch (err) {
                log(`âš ï¸ åŠ è½½é…ç½®å¤±è´¥: ${err.message}`);
                // åŠ è½½é»˜è®¤é…ç½®
                rpcInput.value = DEFAULT_CONFIG.rpc_url;
                contractInput.value = DEFAULT_CONFIG.contract_address;
            }
        }

        // 2. é…ç½®ç®¡ç†ï¼šä¿å­˜é…ç½®
        saveConfigBtn.addEventListener('click', async () => {
            try {
                // éªŒè¯åœ°å€æ ¼å¼
                const contractAddr = contractInput.value.trim();
                const accountAddr = accountInput.value.trim();
                
                if (contractAddr && !Web3.utils.isAddress(contractAddr)) {
                    throw new Error("åˆçº¦åœ°å€æ ¼å¼é”™è¯¯");
                }
                if (accountAddr && !Web3.utils.isAddress(accountAddr)) {
                    throw new Error("è´¦æˆ·åœ°å€æ ¼å¼é”™è¯¯");
                }

                // æ„å»ºé…ç½®å¯¹è±¡
                const config = {
                    rpc_url: rpcInput.value.trim(),
                    contract_address: contractAddr,
                    account_address: accountAddr,
                    private_key: privateKeyInput.value.trim()
                };

                // ä¿å­˜åˆ°LocalStorage
                localStorage.setItem('familyBinderConfig', JSON.stringify(config));
                log("âœ… é…ç½®å·²ä¿å­˜");
                alert("é…ç½®å·²ä¿å­˜");
            } catch (err) {
                log(`âŒ ä¿å­˜é…ç½®å¤±è´¥: ${err.message}`);
                alert(`ä¿å­˜é…ç½®å¤±è´¥: ${err.message}`);
            }
        });

        // 3. åŠ è½½ç§é’¥æ–‡ä»¶
        keyFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    let privateKey = event.target.result.trim();
                    // å¤„ç†0xå‰ç¼€
                    if (privateKey.startsWith('0x')) privateKey = privateKey.slice(2);
                    // éªŒè¯ç§é’¥é•¿åº¦ï¼ˆ64ä½16è¿›åˆ¶å­—ç¬¦ï¼‰
                    if (!/^[0-9a-fA-F]{64}$/.test(privateKey)) {
                        throw new Error("ç§é’¥æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º64ä¸ªå­—ç¬¦çš„16è¿›åˆ¶å­—ç¬¦ä¸²");
                    }
                    privateKeyInput.value = privateKey;
                    log(`âœ… å·²ä»æ–‡ä»¶åŠ è½½ç§é’¥: ${file.name}`);
                } catch (err) {
                    log(`âŒ åŠ è½½ç§é’¥æ–‡ä»¶å¤±è´¥: ${err.message}`);
                    alert(`åŠ è½½ç§é’¥æ–‡ä»¶å¤±è´¥: ${err.message}`);
                }
            };
            reader.readAsText(file);
        });

        // 4. å¼€å§‹ç»‘å®š
        startBtn.addEventListener('click', async () => {
            try {
                // éªŒè¯è¾“å…¥å‚æ•°
                const rootId = parseInt(rootIdInput.value.trim());
                const depth = parseInt(depthInput.value.trim());
                const rpcUrl = rpcInput.value.trim();
                const contractAddr = contractInput.value.trim();
                const accountAddr = accountInput.value.trim();
                const privateKey = privateKeyInput.value.trim();

                // åŸºç¡€éªŒè¯
                if (!rpcUrl) throw new Error("è¯·è¾“å…¥RPC URL");
                if (!contractAddr) throw new Error("è¯·è¾“å…¥åˆçº¦åœ°å€");
                if (!accountAddr) throw new Error("è¯·è¾“å…¥è´¦æˆ·åœ°å€");
                if (!privateKey) throw new Error("è¯·è¾“å…¥ç§é’¥");
                if (isNaN(rootId) || rootId <= 0) throw new Error("æ ¹çˆ¶IDå¿…é¡»ä¸ºæ­£æ•´æ•°");
                if (isNaN(depth) || depth < 1 || depth > 1000) throw new Error("æ·±åº¦å¿…é¡»ä¸º1-10ä¹‹é—´çš„æ•´æ•°");

                // éªŒè¯åœ°å€æ ¼å¼
                if (!Web3.utils.isAddress(contractAddr)) throw new Error("åˆçº¦åœ°å€æ ¼å¼é”™è¯¯");
                if (!Web3.utils.isAddress(accountAddr)) throw new Error("è´¦æˆ·åœ°å€æ ¼å¼é”™è¯¯");
                // éªŒè¯ç§é’¥æ ¼å¼
                const key = privateKey.startsWith('0x') ? privateKey.slice(2) : privateKey;
                if (!/^[0-9a-fA-F]{64}$/.test(key)) throw new Error("ç§é’¥æ ¼å¼ä¸æ­£ç¡®");

                // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
                startBtn.disabled = true;
                stopBtn.disabled = false;
                saveConfigBtn.disabled = true;
                startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                // é‡ç½®è¿›åº¦
                progressBar.style.width = '0%';
                progressLabel.textContent = 'è¿›åº¦: 0%';

                // å‘é€æŒ‡ä»¤ç»™Workerï¼ˆæºå¸¦å®Œæ•´å‚æ•°ï¼‰
                bindingWorker.postMessage({
                    type: "START_BINDING",
                    data: {
                        rpcUrl,
                        contractAddress: Web3.utils.toChecksumAddress(contractAddr),
                        accountAddress: Web3.utils.toChecksumAddress(accountAddr),
                        privateKey: privateKey.startsWith('0x') ? privateKey : `0x${privateKey}`,
                        rootId,
                        depth
                    }
                });
            } catch (err) {
                log(`âš ï¸ è¾“å…¥é”™è¯¯: ${err.message}`);
                alert(`è¾“å…¥é”™è¯¯: ${err.message}`);
            }
        });

        // 5. åœæ­¢ç»‘å®š
        stopBtn.addEventListener('click', () => {
            bindingWorker.postMessage({ type: "STOP_BINDING" });
            stopBtn.disabled = true;
            stopBtn.classList.add('opacity-50', 'cursor-not-allowed');
        });

        // 6. æ¥æ”¶Workeræ¶ˆæ¯ï¼ˆæ›´æ–°UIï¼‰
        bindingWorker.onmessage = (e) => {
            const { type, data } = e.data;

            switch (type) {
                case "LOG":
                    log(data);
                    break;
                case "PROGRESS":
                    progressBar.style.width = `${data}%`;
                    progressLabel.textContent = `è¿›åº¦: ${data}%`;
                    break;
                case "FINISHED":
                    const { success, message } = data;
                    log(message);
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    saveConfigBtn.disabled = false;
                    startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    stopBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    // æç¤ºç»“æœ
                    alert(message);
                    break;
            }
        };

        // 7. æ—¥å¿—å·¥å…·
        function log(msg) {
            logOutput.value += `${msg}\n`;
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // 8. é¡µé¢å…³é—­æ—¶ç»ˆæ­¢Worker
        window.onbeforeunload = () => {
            bindingWorker.terminate();
        };
    </script>
</body>
</html>